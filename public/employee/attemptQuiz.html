<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attempt Quiz</title>
  <script src="/config.js"></script>
  <style>
    body {
      background: linear-gradient(120deg, #f5f7fa 0%, #e9e4f0 100%);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container {
      max-width: 700px;
      margin: 48px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(107,70,193,0.10);
      padding: 36px 28px 32px 28px;
      position: relative;
    }
    .back-btn {
      display: inline-block;
      margin-bottom: 24px;
      background: linear-gradient(90deg, #6b46c1 60%, #805ad5 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 28px;
      font-size: 1.08rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(107,70,193,0.08);
      transition: background 0.2s, box-shadow 0.2s;
      text-decoration: none;
    }
    .back-btn:hover {
      background: linear-gradient(90deg, #805ad5 60%, #6b46c1 100%);
      box-shadow: 0 4px 16px rgba(107,70,193,0.16);
      color: #fff;
      text-decoration: none;
    }
    .quiz-info {
      margin-bottom: 24px;
      padding: 18px 18px 12px 18px;
      background: #f3f4f6;
      border-radius: 12px;
      box-shadow: 0 2px 8px #e9e4f0;
    }
    .quiz-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #6b46c1;
      margin-bottom: 8px;
    }
    .quiz-meta {
      color: #6b7280;
      font-size: 1.05rem;
      margin-bottom: 6px;
    }
    .attempts-info {
      color: #f59e0b;
      font-size: 1.08rem;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .start-btn {
      display: block;
      width: 100%;
      background: linear-gradient(90deg, #6b46c1 60%, #805ad5 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 0;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(107,70,193,0.08);
      transition: background 0.2s, box-shadow 0.2s;
      margin-top: 18px;
    }
    .start-btn:hover {
      background: linear-gradient(90deg, #805ad5 60%, #6b46c1 100%);
      box-shadow: 0 4px 16px rgba(107,70,193,0.16);
      color: #fff;
    }
    .fullscreen-confirm {
      background: #ede9fe;
      border-radius: 10px;
      padding: 24px 18px;
      text-align: center;
      margin-bottom: 18px;
      box-shadow: 0 2px 8px #e9e4f0;
    }
    .fullscreen-confirm button {
      margin: 0 10px;
      padding: 10px 24px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #6b46c1;
      color: #fff;
      transition: background 0.2s;
    }
    .fullscreen-confirm button:hover {
      background: #805ad5;
    }
    #timer {
      position: absolute;
      top: 24px;
      right: 36px;
      font-size: 1.2rem;
      font-weight: 700;
      color: #6b46c1;
      background: #f3f4f6;
      padding: 6px 18px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(107,70,193,0.08);
      z-index: 10;
      display: none;
    }
    .question-block {
      margin-bottom: 22px;
      padding: 18px 14px;
      background: #f9fafb;
      border-radius: 10px;
      box-shadow: 0 2px 8px #e9e4f0;
    }
    .question-title {
      font-size: 1.08rem;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 10px;
    }
    .quiz-options label {
      display: block;
      margin-bottom: 10px;
      background: #f3f4f6;
      border-radius: 7px;
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.18s;
    }
    .quiz-options input[type="radio"] {
      margin-right: 10px;
    }
    .quiz-options label:hover {
      background: #ede9fe;
    }
    .submit-btn {
      background: #6b46c1;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 24px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      margin-top: 18px;
      transition: background 0.2s;
    }
    .submit-btn:hover {
      background: #805ad5;
    }
    .results-section {
      margin-top: 30px;
      background: #f3f4f6;
      border-radius: 12px;
      padding: 24px 0;
      font-size: 1.2rem;
      color: #10b981;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(16,185,129,0.08);
      animation: popIn 0.3s cubic-bezier(.4,2,.6,1) 1;
      text-align: center;
    }
    .explanation-block {
      background: #fff;
      border-radius: 8px;
      margin: 18px 0;
      padding: 14px 12px;
      box-shadow: 0 1px 4px #e0e7ff;
      text-align: left;
    }
    .correct { color: #10b981; font-weight: 700; }
    .incorrect { color: #ef4444; font-weight: 700; }
    @media (max-width: 700px) {
      .container { padding: 10px 2vw; }
      h1 { font-size: 1.3rem; }
      #timer { right: 10px; top: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="/employee/dashboard.html" class="back-btn">&larr; Back to Dashboard</a>
    <div id="timer"></div>
    <div id="quizContent"></div>
  </div>
  <script>
    const quizId = '';
    let quiz = null;
    let questions = [];
    let attemptsLeft = 3;
    let attemptsUsed = 0;
    let timerInterval = null;
    let timeLeft = 0;
    let started = false;

    async function fetchQuizAndAttempts() {
      // Fetch quiz details and questions
      const [quizRes, questionsRes, attemptsRes] = await Promise.all([
        fetch(config.getApiUrl(`/api/quizzes/available`), { headers: config.getAuthHeaders() }),
        fetch(config.getApiUrl(`/api/quizzes/${quizId}/questions`), { headers: config.getAuthHeaders() }),
        fetch(config.getApiUrl(`/api/quizzes/${quizId}/attempts`), { headers: config.getAuthHeaders() })
      ]);
      const quizList = await quizRes.json();
      quiz = (quizList.data || []).find(q => q.id == quizId);
      questions = await questionsRes.json();
      const attemptsData = await attemptsRes.json();
      attemptsUsed = attemptsData.attempts || 0;
      attemptsLeft = Math.max(0, 3 - attemptsUsed);
    }

    function renderQuizInfo() {
      const quizContent = document.getElementById('quizContent');
      quizContent.innerHTML = `
        <div class="quiz-info">
          <div class="quiz-title">${quiz.title}</div>
          <div class="quiz-meta">Category: ${quiz.category} | Difficulty: ${quiz.difficulty} | Duration: ${quiz.duration} min</div>
          <div class="quiz-meta">Questions: ${questions.length}</div>
          <div class="attempts-info">Attempts used: ${attemptsUsed} / 3</div>
          <button class="start-btn" onclick="showFullscreenConfirm()" ${attemptsLeft === 0 ? 'disabled' : ''}>Start Quiz</button>
          ${attemptsLeft === 0 ? '<div style="color:#ef4444;margin-top:10px;">You have used all 3 attempts for this quiz.</div>' : ''}
        </div>
      `;
    }

    function showFullscreenConfirm() {
      const quizContent = document.getElementById('quizContent');
      quizContent.innerHTML = `
        <div class="fullscreen-confirm">
          <div style="font-size:1.15rem;margin-bottom:12px;">You are about to start the quiz in full screen mode. Please confirm to proceed.</div>
          <button onclick="startQuiz(true)">Go Full Screen & Start</button>
          <button onclick="renderQuizInfo()" style="background:#ef4444;">Cancel</button>
        </div>
      `;
    }

    function startQuiz(fullscreen) {
      if (fullscreen && document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      }
      started = true;
      renderQuizQuestions();
      startTimer(quiz.duration * 60);
    }

    function renderQuizQuestions() {
      const quizContent = document.getElementById('quizContent');
      let html = '';
      questions.forEach((q, idx) => {
        const options = q.options.map((opt, i) =>
          `<label><input type="radio" name="q${idx}" value="${i}" required> ${opt}</label>`
        ).join('');
        html += `
          <div class="question-block">
            <div class="question-title">${idx + 1}. ${q.question}</div>
            <div class="quiz-options">${options}</div>
          </div>
        `;
      });
      html += `<button class="submit-btn" onclick="submitQuiz()">Submit Quiz</button>`;
      html += `<div class="attempts-info" style="margin-top:18px;">Attempts used: ${attemptsUsed + 1} / 3</div>`;
      quizContent.innerHTML = html;
      document.getElementById('timer').style.display = 'block';
    }

    function startTimer(seconds) {
      timeLeft = seconds;
      updateTimerDisplay();
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          autoSubmitQuiz();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const min = Math.floor(timeLeft / 60);
      const sec = timeLeft % 60;
      document.getElementById('timer').textContent = `Time Left: ${min}:${sec.toString().padStart(2, '0')}`;
    }

    function autoSubmitQuiz() {
      if (started) submitQuiz();
    }

    async function submitQuiz() {
      clearInterval(timerInterval);
      const quizContent = document.getElementById('quizContent');
      const form = document.createElement('form');
      form.innerHTML = quizContent.innerHTML;
      let score = 0;
      let results = [];
      questions.forEach((q, idx) => {
        const selected = document.querySelector(`input[name='q${idx}']:checked`);
        const selectedVal = selected ? selected.value : null;
        const correct = parseInt(selectedVal) === q.correctAnswer;
        if (correct) score++;
        results.push({
          question: q.question,
          selected: selectedVal !== null ? q.options[selectedVal] : null,
          correctAnswer: q.options[q.correctAnswer],
          explanation: q.explanation || '',
          isCorrect: correct
        });
      });
      // Save submission
      try {
        await fetch(config.getApiUrl(`/api/quizzes/${quizId}/submit`), {
          method: 'POST',
          headers: config.getAuthHeaders(),
          body: JSON.stringify({ score, total: questions.length, results })
        });
      } catch (err) {}
      showResults(results, score, questions.length);
      document.getElementById('timer').style.display = 'none';
      started = false;
    }

    function showResults(results, score, total) {
      let html = `<div class='results-section'>You scored <span style='color:#6b46c1;'>${score}</span> out of <span style='color:#6b46c1;'>${total}</span>!</div>`;
      results.forEach((r, idx) => {
        html += `
          <div class="explanation-block">
            <div><b>${idx + 1}. ${r.question}</b></div>
            <div>Your answer: <span class="${r.isCorrect ? 'correct' : 'incorrect'}">${r.selected !== null ? r.selected : '<i>Not answered</i>'}</span></div>
            <div>Correct answer: <b>${r.correctAnswer}</b></div>
            <div style="color:#6b7280;">Explanation: ${r.explanation || 'No explanation provided.'}</div>
          </div>
        `;
      });
      html += `<a href="/employee/dashboard.html" class="back-btn" style="margin-top:24px;">&larr; Back to Dashboard</a>`;
      document.getElementById('quizContent').innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', async function() {
      try {
        await fetchQuizAndAttempts();
        renderQuizInfo();
      } catch (err) {
        document.getElementById('quizContent').innerHTML = '<div style="color:#ef4444;">Could not load quiz or attempts.</div>';
      }
    });
  </script>
</body>
</html> 